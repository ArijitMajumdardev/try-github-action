name: Build and Package

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build and Create Release
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Required to create releases

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Build Project
        run: |
          echo "ðŸ”¨ Building project with obfuscation..."
          npm run build
          echo "âœ… Build completed"

      - name: Verify Build
        run: |
          echo "ðŸ” Verifying build output..."

          # Count files
          JS_COUNT=$(find dist -name "*.js" | wc -l)
          MAP_COUNT=$(find dist -name "*.js.map" | wc -l)

          echo "ðŸ“Š Build statistics:"
          echo "  - JavaScript files: $JS_COUNT"
          echo "  - Source map files: $MAP_COUNT"
          echo "  - Dist size: $(du -sh dist | cut -f1)"

          # Verify obfuscation
          if grep -q "_0x" dist/index.js; then
            echo "âœ… Code is obfuscated"
          else
            echo "âš ï¸  Warning: Code might not be obfuscated"
          fi

      - name: Prepare Production Files
        run: |
          echo "ðŸ“¦ Preparing production files (without source maps)..."
          mkdir -p production-files

          # Copy all .js files recursively (excluding .map and .test.js)
          rsync -av --include='*/' --include='*.js' --exclude='*.map' --exclude='*.test.js' dist/ production-files/

          # Verify no source maps in production
          MAP_COUNT=$(find production-files -name "*.map" | wc -l)
          if [ "$MAP_COUNT" -gt 0 ]; then
            echo "âŒ Error: Found $MAP_COUNT source map files in production!"
            exit 1
          fi

          echo "âœ… Production files ready:"
          echo "  - JS files: $(find production-files -name '*.js' | wc -l)"
          echo "  - Size: $(du -sh production-files | cut -f1)"

      - name: Prepare Source Maps
        run: |
          echo "ðŸ“‹ Preparing source maps..."
          mkdir -p sourcemaps-package

          # Copy all .js.map files recursively with directory structure
          rsync -av --include='*/' --include='*.js.map' --exclude='*' dist/ sourcemaps-package/

          echo "âœ… Source maps ready:"
          echo "  - Map files: $(find sourcemaps-package -name '*.js.map' | wc -l)"
          echo "  - Size: $(du -sh sourcemaps-package | cut -f1)"

      - name: Generate Version Tag
        id: version
        run: |
          # Get version from package.json
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          VERSION="v${PACKAGE_VERSION}-build.${{ github.run_number }}"

          echo "tag=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Generated version: ${VERSION}"

      - name: Create Production Files Archive
        run: |
          echo "ðŸ“¦ Creating production-files.zip..."
          cd production-files
          zip -r ../production-files.zip . -x "*.DS_Store"
          cd ..

          ZIP_SIZE=$(du -sh production-files.zip | cut -f1)
          echo "âœ… Archive created: ${ZIP_SIZE}"

      - name: Create Source Maps Archive
        run: |
          echo "ðŸ“¦ Creating sourcemaps.zip..."
          cd sourcemaps-package
          zip -r ../sourcemaps.zip . -x "*.DS_Store"
          cd ..

          ZIP_SIZE=$(du -sh sourcemaps.zip | cut -f1)
          echo "âœ… Archive created: ${ZIP_SIZE}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body: |
            ## Automated Release

            **Build Information:**
            - Commit: `${{ github.sha }}`
            - Branch: `${{ github.ref_name }}`
            - Workflow Run: #${{ github.run_number }}
            - Triggered by: @${{ github.actor }}

            **Commit Message:**
            ```
            ${{ github.event.head_commit.message }}
            ```

            **Release Assets:**
            - `production-files.zip` - Production JavaScript files (obfuscated, no source maps)
            - `sourcemaps.zip` - Source map files for debugging

            ---
            *This release was automatically generated by GitHub Actions*
          files: |
            production-files.zip
            sourcemaps.zip
          draft: false
          prerelease: false
          generate_release_notes: true
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
